#!/usr/bin/env php
<?php declare(strict_types=1);
// Copyright (C) 2015-2025 Mark Constable <mc@netserva.org> (MIT License)
// Filesystem operations for mailbox info (runs as root via SSH)
// NS 3.0 path structure: /srv/domain/msg/user
// Usage: shvmail user@domain.tld [--size]

if (php_sapi_name() !== 'cli') {
    die("CLI only\n");
}

$email = $argv[1] ?? null;
$showSize = in_array('--size', $argv);

if (!$email || $email === '--size') {
    fwrite(STDERR, "Usage: shvmail <email> [--size]\n");
    exit(1);
}

$email = strtolower($email);
[$user, $domain] = explode('@', $email);

// NS 3.0 path
$home = "/srv/{$domain}/msg/{$user}";

if (!is_dir($home)) {
    fwrite(STDERR, "Error: Maildir not found: {$home}\n");
    exit(1);
}

// Get directory size
function dirSize(string $path): int {
    $size = 0;
    $iterator = new RecursiveIteratorIterator(
        new RecursiveDirectoryIterator($path, FilesystemIterator::SKIP_DOTS)
    );
    foreach ($iterator as $file) {
        $size += $file->getSize();
    }
    return $size;
}

$stat = stat($home);
$size = dirSize($home);

// Count messages
$msgCount = 0;
$maildir = "{$home}/Maildir";
if (is_dir($maildir)) {
    foreach (['cur', 'new'] as $folder) {
        $folderPath = "{$maildir}/{$folder}";
        if (is_dir($folderPath)) {
            $msgCount += count(array_diff(scandir($folderPath), ['.', '..']));
        }
    }
}

echo "OK\n";
echo "Email: {$email}\n";
echo "Home: {$home}\n";
echo "UID: {$stat['uid']}\n";
echo "GID: {$stat['gid']}\n";
echo "Size: {$size}\n";
echo "Messages: {$msgCount}\n";
exit(0);
